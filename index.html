{% extends "base.html" %}

{% block title %}Home - Cryptocurrency Wallet{% endblock %}

{% block content %}
<div class="hero">
    <h1>Welcome to CryptoWallet</h1>
    <p>A simple, secure, and feature-rich cryptocurrency wallet for managing your digital assets</p>
</div>

<div class="action-cards">
    <!-- Create New Wallet -->
    <div class="card">
        <div class="card-header">
            <h2>üÜï Create New Wallet</h2>
        </div>
        <div class="card-body">
            <p>Generate a new wallet with a unique address and private key.</p>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                ‚ú® Includes: 1000 initial coins, QR code, backup options, and 2FA support
            </p>
            <button onclick="createWallet()" class="btn btn-primary btn-block">Create Wallet</button>
        </div>
    </div>

    <!-- Access Existing Wallet -->
    <div class="card">
        <div class="card-header">
            <h2>üîì Access Existing Wallet</h2>
        </div>
        <div class="card-body">
            <form id="accessForm" onsubmit="accessWallet(event)">
                <div class="form-group">
                    <label for="address">Wallet Address</label>
                    <input type="text" id="address" name="address" 
                           placeholder="0x..." required class="form-control">
                </div>
                <div class="form-group">
                    <label for="privateKey">Private Key</label>
                    <input type="password" id="privateKey" name="privateKey" 
                           placeholder="Your private key" required class="form-control">
                </div>
                <button type="submit" class="btn btn-success btn-block">Access Wallet</button>
            </form>
        </div>
    </div>

    <!-- Restore from Backup -->
    <div class="card">
        <div class="card-header">
            <h2>üîÑ Restore Wallet</h2>
        </div>
        <div class="card-body">
            <p>Restore your wallet using your backup mnemonic phrase.</p>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                üíæ Enter your 12-word backup phrase to recover access
            </p>
            <button onclick="showRestoreModal()" class="btn btn-warning btn-block">Restore from Backup</button>
        </div>
    </div>
</div>

<!-- Features Section -->
<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <h2>‚ú® Features</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem;">
            <div>
                <h3 style="color: var(--primary-color); margin-bottom: 0.5rem;">üîê Security</h3>
                <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                    <li>‚úì Two-Factor Authentication</li>
                    <li>‚úì Encrypted Backups</li>
                    <li>‚úì Multi-Signature Wallets</li>
                </ul>
            </div>
            <div>
                <h3 style="color: var(--success-color); margin-bottom: 0.5rem;">‚ö° Real-time</h3>
                <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                    <li>‚úì Live Balance Updates</li>
                    <li>‚úì Instant Notifications</li>
                    <li>‚úì Exchange Rate Tracking</li>
                </ul>
            </div>
            <div>
                <h3 style="color: var(--info-color); margin-bottom: 0.5rem;">üìä Exports</h3>
                <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                    <li>‚úì CSV Downloads</li>
                    <li>‚úì PDF Reports</li>
                    <li>‚úì QR Code Generation</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Modal for new wallet -->
<div id="walletModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('walletModal')">&times;</span>
        <h2>‚úÖ Wallet Created Successfully!</h2>
        <div id="walletInfo" class="wallet-info"></div>
        <div class="modal-footer">
            <button onclick="copyPrivateKey()" class="btn btn-secondary">
                üìã Copy Private Key
            </button>
            <button onclick="goToWallet()" class="btn btn-primary">
                üöÄ Go to Wallet
            </button>
        </div>
    </div>
</div>

<!-- Restore Wallet Modal -->
<div id="restoreModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('restoreModal')">&times;</span>
        <h2>üîÑ Restore Wallet from Backup</h2>
        <form id="restoreForm" onsubmit="restoreWallet(event)">
            <div class="form-group">
                <label for="mnemonic">Mnemonic Phrase (12 words)</label>
                <textarea 
                    id="mnemonic" 
                    name="mnemonic" 
                    class="form-control" 
                    rows="4"
                    placeholder="Enter your 12-word backup phrase separated by spaces"
                    required
                    style="font-family: monospace;"
                ></textarea>
                <small style="color: var(--text-secondary);">
                    Example: abandon ability able about above absent absorb abstract absurd abuse access accident
                </small>
            </div>
            <div class="form-group">
                <label for="restorePassword">Password (used when creating backup)</label>
                <input 
                    type="password" 
                    id="restorePassword" 
                    name="restorePassword" 
                    class="form-control" 
                    placeholder="Enter your backup password"
                    required
                >
            </div>
            <button type="submit" class="btn btn-primary btn-block">Restore Wallet</button>
        </form>
        <div id="restoreResult" style="margin-top: 1rem;"></div>
    </div>
</div>

<!-- Loading spinner -->
<div id="loadingSpinner" class="spinner-overlay" style="display: none;">
    <div class="spinner"></div>
</div>

<!-- Notification Container -->
<div id="notificationContainer"></div>

{% endblock %}

{% block scripts %}
<script>
let currentWalletAddress = '';

async function createWallet() {
    showLoading();
    try {
        const response = await fetch('/create_wallet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            displayWalletInfo(result.data);
            currentWalletAddress = result.data.address;
            showNotification('Wallet created successfully! üéâ', 'success');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('Error creating wallet: ' + error.message, 'error');
    }
}

function displayWalletInfo(data) {
    const walletInfo = document.getElementById('walletInfo');
    walletInfo.innerHTML = `
        <div class="info-item">
            <strong>Wallet Address:</strong>
            <div class="info-value">${data.address}</div>
        </div>
        <div class="info-item warning-box">
            <strong>‚ö†Ô∏è Private Key (Save this securely!):</strong>
            <div class="info-value" id="modalPrivateKey">${data.private_key}</div>
            <p class="warning-text">
                üîí This is the only time you'll see your private key!<br>
                üìù Write it down and store it safely.<br>
                üíæ You can also create an encrypted backup from your wallet dashboard.
            </p>
        </div>
        <div class="info-item">
            <strong>Initial Balance:</strong>
            <div class="info-value">${data.balance} COIN</div>
        </div>
        <div class="info-item" style="background: rgba(79, 70, 229, 0.1); padding: 1rem; border-radius: 0.5rem;">
            <strong>üéØ Next Steps:</strong>
            <ol style="margin: 0.5rem 0 0 1.5rem; color: var(--text-secondary);">
                <li>Copy and save your private key</li>
                <li>Go to your wallet dashboard</li>
                <li>Enable 2FA for extra security</li>
                <li>Create an encrypted backup</li>
            </ol>
        </div>
    `;
    document.getElementById('walletModal').style.display = 'block';
}

async function accessWallet(event) {
    event.preventDefault();
    
    const address = document.getElementById('address').value.trim();
    const privateKey = document.getElementById('privateKey').value.trim();
    
    if (!address || !privateKey) {
        showNotification('Please fill in all fields', 'error');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/access_wallet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: address,
                private_key: privateKey
            })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            showNotification('Access granted! Redirecting...', 'success');
            setTimeout(() => {
                window.location.href = `/wallet/${address}`;
            }, 1000);
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('Error accessing wallet: ' + error.message, 'error');
    }
}

function showRestoreModal() {
    document.getElementById('restoreModal').style.display = 'block';
}

async function restoreWallet(event) {
    event.preventDefault();
    
    const mnemonic = document.getElementById('mnemonic').value.trim();
    const password = document.getElementById('restorePassword').value.trim();
    
    // Validate mnemonic
    const words = mnemonic.split(/\s+/);
    if (words.length !== 12) {
        showNotification('Mnemonic phrase must be exactly 12 words', 'error');
        return;
    }
    
    showLoading();
    try {
        const response = await fetch('/restore_wallet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                mnemonic: mnemonic,
                password: password
            })
        });
        
        const result = await response.json();
        hideLoading();
        
        if (result.success) {
            const resultDiv = document.getElementById('restoreResult');
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <strong>‚úÖ Mnemonic Validated!</strong><br>
                    Your backup phrase is valid with ${result.data.word_count} words.<br>
                    <small>Note: In this educational version, you'll still need your original wallet address and private key to access your wallet.</small>
                </div>
            `;
            showNotification('Backup phrase validated successfully!', 'success');
        } else {
            showNotification('Error: ' + result.error, 'error');
        }
    } catch (error) {
        hideLoading();
        showNotification('Error restoring wallet: ' + error.message, 'error');
    }
}

function goToWallet() {
    if (currentWalletAddress) {
        window.location.href = `/wallet/${currentWalletAddress}`;
    }
}

function copyPrivateKey() {
    const privateKeyElement = document.getElementById('modalPrivateKey');
    
    if (!privateKeyElement) {
        showNotification('Private key element not found', 'error');
        console.error('Element with id "modalPrivateKey" not found');
        return;
    }
    
    const privateKey = privateKeyElement.textContent || privateKeyElement.innerText;
    
    if (!privateKey) {
        showNotification('No private key to copy', 'error');
        return;
    }
    
    // Try modern clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(privateKey).then(() => {
            showNotification('Private key copied to clipboard! ‚úÖ', 'success');
        }).catch(err => {
            console.error('Clipboard API failed:', err);
            // Fallback to old method
            fallbackCopyToClipboard(privateKey);
        });
    } else {
        // Use fallback for older browsers
        fallbackCopyToClipboard(privateKey);
    }
}

function fallbackCopyToClipboard(text) {
    // Create temporary textarea
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.top = '0';
    textarea.style.left = '0';
    textarea.style.width = '2em';
    textarea.style.height = '2em';
    textarea.style.padding = '0';
    textarea.style.border = 'none';
    textarea.style.outline = 'none';
    textarea.style.boxShadow = 'none';
    textarea.style.background = 'transparent';
    
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            showNotification('Private key copied to clipboard! ‚úÖ', 'success');
        } else {
            showNotification('Failed to copy - please copy manually', 'error');
        }
    } catch (err) {
        console.error('Fallback copy failed:', err);
        showNotification('Failed to copy - please copy manually', 'error');
    }
    
    document.body.removeChild(textarea);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function showLoading() {
    document.getElementById('loadingSpinner').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingSpinner').style.display = 'none';
}

function showNotification(message, type = 'info') {
    // Get or create notification container
    let container = document.getElementById('notificationContainer');
    
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.style.position = 'fixed';
        container.style.top = '80px';
        container.style.right = '20px';
        container.style.zIndex = '9999';
        document.body.appendChild(container);
    }
    
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    
    // Add inline styles for guaranteed visibility
    notification.style.padding = '1rem 1.5rem';
    notification.style.marginBottom = '10px';
    notification.style.borderRadius = '0.5rem';
    notification.style.boxShadow = '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)';
    notification.style.color = 'white';
    notification.style.fontWeight = '500';
    notification.style.fontSize = '0.95rem';
    notification.style.maxWidth = '350px';
    notification.style.wordWrap = 'break-word';
    notification.style.animation = 'slideInRight 0.3s ease-out';
    notification.style.cursor = 'pointer';
    
    // Set background color based on type
    if (type === 'success') {
        notification.style.backgroundColor = '#10b981';
    } else if (type === 'error') {
        notification.style.backgroundColor = '#ef4444';
    } else if (type === 'warning') {
        notification.style.backgroundColor = '#f59e0b';
    } else {
        notification.style.backgroundColor = '#3b82f6';
    }
    
    // Click to dismiss
    notification.onclick = function() {
        notification.style.animation = 'slideOutRight 0.3s ease-out';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    };
    
    // Add to container
    container.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    }, 4000);
}

// Add animation styles if not already present
if (!document.getElementById('notificationStyles')) {
    const style = document.createElement('style');
    style.id = 'notificationStyles';
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        #notificationContainer {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
        }
    `;
    document.head.appendChild(style);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const walletModal = document.getElementById('walletModal');
    const restoreModal = document.getElementById('restoreModal');
    
    if (event.target == walletModal) {
        walletModal.style.display = 'none';
    }
    if (event.target == restoreModal) {
        restoreModal.style.display = 'none';
    }
}

// Initialize notification system on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded - notification system ready');
    // Test notification (optional - comment out in production)
    // showNotification('CryptoWallet loaded successfully! ‚úÖ', 'success');
});
</script>
{% endblock %}